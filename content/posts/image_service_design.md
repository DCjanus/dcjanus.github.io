---
title: "图片服务设计"
date: 2021-12-11T23:42:56+08:00
draft: true
authors: ['DCjanus']
tags: ['业务设计']
---

对于大部分网站来说，图片都是一类重要的展示形式，本人目前（2022年7月）供职于某 UGC 网站，主要工作是维护企业自研对象存储与图片服务。

这是一个相对小众的领域，说不上难度，但因为缺乏公开资料，从头摸索往往会走一些弯路，浪费一些人力物力。

本文尝试稍微总结图片服务演进过程中遇到的问题，也可以让更多人了解到，为了将司空见惯的图片展示在用户面前，工程师们做了哪些努力。

<!--more-->

# 需求

## 背景

本文假设的需求背景：日均 PV 千万量级的 UGC 视频网站，有至少安卓、iOS 和网页三端对用户提供服务，三端请求量基本相等；单个页面有多张图片，基本只用访问缩略图而不是原图；有较强意愿自建机房和基础服务；企业组织架构较为复杂，基础服务与实际业务团队之间存在一定隔阂，没有充沛甚至过剩的人力；运营主体在中国大陆，需要接受有关部门监管。（出于数据保密的需求，该场景并不对应本人所在公司实际场景，但由于图片服务较容易水平扩容，单个数量级差异不影响总体设计取舍）

对于 UGC 类网站，往往支持如自定义头像、发布图文等功能。单从技术角度考虑，需要支持图片的上传、存储、分发和展示，且由于图片服务往往是核心服务，图片服务不可用往往会直接对用户使用产生影响；技术之外，随着企业组织架构的庞大，基础服务团队和业务开发团队之间人员数量、人员质量和价值追求存在差异，这也要求图片服务维护者要做好业务治理的工作，在尽量小的人力开销下，避免服务被滥用、误用。

## 拆解

### 展示

不论是上传还是存储，最终目的是让更多用户能够看到最终内容，所以本节首先讨论展示流程的细节。

日常使用时，用户粗略浏览并不需要高清大图，且移动设备内存和性能有限，文件尺寸和体积过大，会导致网络下载速度较慢，解码和展示性能要求高，为了满足用户流畅访问的需求，往往会展示尺寸和体积较小的缩略图。

<!-- 以下为之前一版草稿 -->

# 设计

## 1. 在线/离线

相比简单的 CRUD 接口，图片处理是一个相对较慢的过程，设计为一个离线服务往往是较为直接的思路。但事实上由于现实情况的限制，绝大多数网站的图片处理都不会是一个离线服务，以新浪微博为例：

我在发微博页面尝试上传了一张 3840x2160 的图片，F12 抓包可以看到返回了一个 ID，随后网页 JS 将这个 ID 拼接到 URL 中，请求获取到了一张相对较小的 JPEG，其尺寸为 400x248，表现为在微博发送页面，展示了我刚刚上传图片的缩略图。

也就是说，大量场景下，要求用户上传后相对较快的可以看到图片转换后的结果，一般来说及时性要求是百毫秒级。另一方面，离线图像处理要求服务提供者有能力感知某个图片上传后所有可能的展示形式，提前为之生成对应图像并存储一定时间。对于大型企业来说，这往往是难以承受的。

但设计为在线处理，服务要保证绝大多数请求能够在可接受时间内完成，图像格式繁多，UGC 内容千奇百怪，绝大部分企业没有能力自研适配如此广泛的图片处理基础库；使用 ImageMgaick、libvips 之类的库，又因为缺乏调度点，CPU 密集的图像处理逻辑陷入后，应用层难以细粒度调度，特殊图片、超级大图处理耗时数分钟的情况并不罕见，需要避免少量重型任务影响总体服务质量。

## 2. 分隔符/请求参数

图片处理服务的调用，主要是为了传递“选择某张图”和“应用在其上的处理操作”两部分信息，一般通过 URL 的修改实现类似功能，但不同的调用形式之间也存在一些细微的区别。常见公有云图片处理服务主要是分隔符和请求参数两类形式，少数公开服务使用多级路径。

以阿里云旧版图片处理服务为例，其设计上使用 `@` 分隔图片地址和处理参数，如:

{{< image src="https://image-demo.img-cn-hangzhou.aliyuncs.com/example.jpg@300w_300h.webp" caption="https://image-demo.img-cn-hangzhou.aliyuncs.com/example.jpg@300w_300h.webp" width=300 >}}

其中 `@` 符号前的是[原始图片地址](https://image-demo.img-cn-hangzhou.aliyuncs.com/example.jpg)，其后`300w_300h.webp`为缩略图参数，表示将原图等比例缩放为一个宽不大于300、高不大于300的 webp 图片。

阿里云新版图片处理服务则使用请求参数的形式，如与上面缩略图参数等价的请求：

{{< image src="https://image-demo.oss-cn-hangzhou.aliyuncs.com/example.jpg?x-oss-process=image/resize,w_300/format,webp" caption="https://image-demo.oss-cn-hangzhou.aliyuncs.com/example.jpg?x-oss-process=image/resize,w_300/format,webp" width=300 >}}

这里的缩略参数是`image/resize,w_300/format,webp`。

选择使用请求参数，要注意 CDN 和 内部缓存集群的缓存 Key 配置，要将特定的 Query Parameter Key 作为缓存 Key 的一部分。

选择使用 `@` 符号分隔，意味着原始文件名中的 `@` 符号可能造成一些非预期现象，如 `a.jpg@2x`、`a.jpg@3x` 是常见的设计资源命名形式，对于使用 `@` 符号分隔的服务，则有可能被认为尝试传递一个错误的图片处理参数。

这类场景往往将普通文件访问域名和图片处理域名区分开，如访问 `example.com/a.jpg@100w` 表示访问存储系统中名为 `a.jpg@100w` 的文件，访问`image.example.com/a.jpg@100w` 则表示请求 `example.com/a.jpg` 并进行处理。

由于内部实现细节的影响，部分 CDN 厂商只提供基于 `/` 分隔的前缀删除，这意味着你无法简单清理 `example.com/a.jpg@100w` 和 `example.com/a.jpg@200w` 的缓存。部分 CDN 厂商可能提供基于阉割版正则的批量清理逻辑，可以覆盖这类场景。

## 3. 自由组合/可配置模板

在统一图片服务的设计初期，工程师们往往着眼于如何让图片处理更加灵活，更加简单，减少图片服务团队和业务团队之间沟通所需的人力成本，提供大量图片处理参数，可以拼接组合满足大量业务场景需求。

但随着业务的不断演进，需求越来越复杂，演化过程中的 BUG，因为图片服务视角缺乏业务场景信息，任何外在表现的改动都有可能导致特定业务场景受损，需要无限期兼容历史 BUG。

仍然以阿里云图片服务为例，其提供了一种名为[图片样式](https://help.aliyun.com/document_detail/48884.html)的功能，即将一些特定的处理逻辑附加在一个特定的名字上，调用方在 URL 中使用这个名字，就意味着调用这个名字所对应的处理逻辑，而不需要拼接各种参数。

对于自建图片服务的企业来说，一般要求不同业务场景使用不同样式名，即使图片处理需求相同，也应该使用独立的名字，图片服务团队可以借此感知业务场景，降低管控成本。但这会导致不同场景的相同图片处理请求无法共享缓存。

除此之外，由于不同分辨率的设备上往往需要请求不同尺寸的图片，这意味着“选择图片处理参数”的逻辑往往写死在客户端，对于移动 APP 来说，出现线上问题、选择错图片处理参数时，修复问题只能通过发布新版本实现，会让问题修复周期无比漫长。如果客户端请求的是模板名，而不是直接使用缩略参数，则可以由服务端进行兼容，大大缩短问题修复时间。

## 4. 业务与处理逻辑分离

每个服务设计者都希望自己的用户是 Pwoer User：主动阅读文档、快速理解设计、能够将需求翻译为容易理解的语言，但现实生活中，来咨询你的程序员可能是三个月前刚从培训班毕业、指着他们组里自行维护的闭源框架代码问你为什么不能工作；即使现实情况没有这么糟糕，但大部分时候，编写代码的前端工程师、客户端工程师，往往也不希望在这样一个对他们来说“毫不起眼”的功能上研究太久，如果你的文档过于晦涩难懂，如果你的背景介绍太过冗长，一定会让人恼怒的。

这意味着，我们需要对外暴露尽可能接近业务感知的功能：如果宽大于高，先裁剪出来头部三分之一的区域，裁剪出来的图像放大到短边长度为 100px，随后中心裁剪出 100x100 的区域，再缩放为 50x50。对内转换为更实际的处理逻辑：裁剪 (a, b) 到 (c, d) 区域，缩放为 50x50。而不是混淆业务抽象和实际处理逻辑，真的按照业务描述执行多次图像处理操作。

## 5. ImageMgaick 的一些坑

TODO